\documentclass[letterpaper]{article}
\usepackage{common/ohpc-doc}
\setcounter{secnumdepth}{5}
\setcounter{tocdepth}{5}

% Include git variables
\input{vc.tex}

% Define Base OS and other local macros
\newcommand{\baseOS}{CentOS8.1}
\newcommand{\OSRepo}{CentOS\_8.1}
\newcommand{\OSTree}{CentOS\_8}
\newcommand{\OSTag}{el8}
\newcommand{\baseos}{centos8.1}
\newcommand{\baseosshort}{centos8}
\newcommand{\provisioner}{xCAT}
\newcommand{\provheader}{xCAT (stateful)}
\newcommand{\rms}{SLURM}
\newcommand{\rmsshort}{slurm}
\newcommand{\arch}{x86\_64}
\newcommand{\installimage}{install}
%%% WARNING: Hack below. The version should be read from ohpc-doc.sty, but the
%%% perl parsing script does not read that file. This works for one release, but
%%% needs a proper fix.
\newcommand{\VERLONG}{1.3.6}

% Define package manager commands
\newcommand{\pkgmgr}{yum}
\newcommand{\addrepo}{wget -P /etc/yum.repos.d}
\newcommand{\chrootaddrepo}{wget -P \$CHROOT/etc/yum.repos.d}
\newcommand{\clean}{yum clean expire-cache}
\newcommand{\chrootclean}{yum --installroot=\$CHROOT clean expire-cache}
\newcommand{\install}{yum -y install}
\newcommand{\chrootinstall}{psh compute yum -y install}
\newcommand{\groupinstall}{yum -y groupinstall}
\newcommand{\groupchrootinstall}{psh compute yum -y groupinstall}
\newcommand{\remove}{yum -y remove}
\newcommand{\upgrade}{yum -y upgrade}
\newcommand{\chrootupgrade}{yum -y --installroot=\$CHROOT upgrade}
\newcommand{\tftppkg}{syslinux-tftpboot}
\newcommand{\beegfsrepo}{https://www.beegfs.io/release/beegfs\_7\_1/dists/beegfs-rhel7.repo}

% boolean for os-specific formatting
\toggletrue{isCentOS}
\toggletrue{isCentOS_ww_slurm_x86}
\toggletrue{isSLURM}
\toggletrue{isx86}
\toggletrue{isxCAT}
\toggletrue{isxCATstateful}

\begin{document}
\graphicspath{{common/figures/}}
\thispagestyle{empty}

% Title Page
\input{common/title}
% Disclaimer 
\input{common/legal} 

\newpage
\tableofcontents
\newpage

% Introduction  --------------------------------------------------

\section{Introduction} \label{sec:introduction}
\input{common/install_header}
\input{common/intro} \\

\input{common/base_edition/edition}
\input{common/audience}
\input{common/requirements}
\input{common/inputs}


% Base Operating System --------------------------------------------

\section{Install Base Operating System (BOS)}
\input{common/bos}

%\clearpage 
% begin_ohpc_run
% ohpc_validation_newline
% ohpc_validation_comment Disable firewall 
\begin{lstlisting}[language=bash,keywords={}]
[sms](*\#*) systemctl disable firewalld
[sms](*\#*) systemctl stop firewalld
\end{lstlisting}
% end_ohpc_run

% ------------------------------------------------------------------

\section{Install \xCAT{} and Provision Nodes with BOS} \label{sec:provision_compute_bos}
\input{common/xcat_stateful_compute_bos_intro}

\subsection{Enable \xCAT{} repository for local use} \label{sec:enable_xcat}
\input{common/enable_xcat_repo}

\noindent \xCAT{} has a number of dependencies that are required for
installation that are housed in separate public repositories for various
distributions. To enable for local use, issue the following:

% begin_ohpc_run
\begin{lstlisting}[language=bash,keywords={},basicstyle=\fontencoding{T1}\fontsize{8.0}{10}\ttfamily,literate={ARCH}{\arch{}}1 {-}{-}1]
[sms](*\#*) (*\addrepo*) https://xcat.org/files/xcat/repos/yum/xcat-dep/rh7/ARCH/xcat-dep.repo
\end{lstlisting}
% end_ohpc_run

\subsection{Add provisioning services on {\em master} node} \label{sec:add_provisioning}
\input{common/install_provisioning_xcat_intro_stateful}
%\input{common/enable_pxe}

\vspace*{-0.15cm}
\subsection{Complete basic \xCAT{} setup for {\em master} node} \label{sec:setup_xcat}
\input{common/xcat_setup}


\subsection{Define {\em compute} image for provisioning}
\input{common/xcat_init_os_images_centos}

\subsection{Add compute nodes into \xCAT{} database} \label{sec:xcat_add_nodes}
\input{common/add_xcat_hosts_intro}

%\vspace*{-0.25cm}
\subsection{Boot compute nodes} \label{sec:boot_computes}
\input{common/reset_computes_xcat} 




\section{Install \OHPC{} Components} \label{sec:basic_install}
\input{common/install_ohpc_components_intro}


\subsection{Enable \OHPC{} repository for local use} \label{sec:enable_repo}
\input{common/enable_local_ohpc_repo}

% begin_ohpc_run
% ohpc_validation_newline
% ohpc_validation_comment Verify OpenHPC repository has been enabled before proceeding
% ohpc_validation_newline
% ohpc_command yum repolist | grep -q OpenHPC
% ohpc_command if [ $? -ne 0 ];then
% ohpc_command    echo "Error: OpenHPC repository must be enabled locally"
% ohpc_command    exit 1
% ohpc_command fi
% end_ohpc_run


In addition to the \OHPC{} and \xCAT{} package repositories, the {\em master} host also
requires access to the standard base OS distro repositories in order to resolve
necessary dependencies. For \baseOS{}, the requirements are to have access to
both the base OS and EPEL repositories for which mirrors are freely available online:

\begin{itemize*}
\item CentOS-7 - Base 7.7.1908
  (e.g. \href{http://mirror.centos.org/centos-7/7/os/x86\_64}
             {\color{blue}{http://mirror.centos.org/centos-7/7/os/x86\_64}} )
\item EPEL 7 (e.g. \href{http://download.fedoraproject.org/pub/epel/7/x86\_64}
                        {\color{blue}{http://download.fedoraproject.org/pub/epel/7/x86\_64}} )
\end{itemize*}

\noindent The public EPEL repository is enabled by installing
\texttt{epel-release} package. Note that this requires the CentOS Extras
repository, which is shipped with CentOS and is enabled by default.

% begin_ohpc_run
\begin{lstlisting}[language=bash,keywords={},basicstyle=\fontencoding{T1}\fontsize{8.0}{10}\ttfamily,literate={ARCH}{\arch{}}1 {-}{-}1]
[sms](*\#*)  (*\install*) epel-release
\end{lstlisting}
% end_ohpc_run

Now \OHPC{} packages can be installed. To add the base package on the SMS
issue the following
% begin_ohpc_run
\begin{lstlisting}[language=bash,keywords={},basicstyle=\fontencoding{T1}\fontsize{8.0}{10}\ttfamily,literate={ARCH}{\arch{}}1 {-}{-}1]
[sms](*\#*)  (*\install*) ohpc-base
\end{lstlisting}
% end_ohpc_run


\input{common/automation}


\subsection{Setup time synchronization service on {\em master} node} \label{sec:add_ntp}
\input{common/time}

\subsection{Add resource management services on {\em master} node} \label{sec:add_rm}
\input{common/install_slurm}

\subsection{Optionally add \InfiniBand{} support services on {\em master} node} \label{sec:add_ofed}
\input{common/ibsupport_sms_centos}

\subsection{Optionally add \OmniPath{} support services on {\em master} node} \label{sec:add_opa}
\input{common/opasupport_sms_centos}

\vspace*{-0.2cm}
\subsubsection{Add \OHPC{} components to {\em compute} nodes} \label{sec:add_components}
\input{common/add_to_compute_stateful_xcat_intro}

%\newpage
% begin_ohpc_run
% ohpc_validation_comment Add OpenHPC components to compute instance
\begin{lstlisting}[language=bash,literate={-}{-}1,keywords={},upquote=true]
# Add Slurm client support meta-package
[sms](*\#*) (*\chrootinstall*) ohpc-slurm-client

# Add Network Time Protocol (NTP) support
[sms](*\#*) (*\chrootinstall*) ntp

# Add kernel drivers
[sms](*\#*) (*\chrootinstall*) kernel

# Include modules user environment
[sms](*\#*) (*\chrootinstall*) lmod-ohpc
\end{lstlisting}
% end_ohpc_run

% ohpc_comment_header Optionally add InfiniBand support services in compute node image \ref{sec:add_components}
% ohpc_command if [[ ${enable_ib} -eq 1 ]];then
% ohpc_indent 5
\begin{lstlisting}[language=bash,literate={-}{-}1,keywords={},upquote=true]
# Optionally add IB support and enable
[sms](*\#*) (*\groupchrootinstall*) "InfiniBand Support"
[sms](*\#*) (*\chrootinstall*) infinipath-psm
[sms](*\#*) psh compute systemctl enable rdma
[sms](*\#*) psh compute systemctl start rdma
\end{lstlisting}
% ohpc_indent 0
% ohpc_command fi
% end_ohpc_run

\vspace*{-0.25cm}
\subsubsection{Customize system configuration} \label{sec:master_customization}
\input{common/xcat_stateful_customize_centos}

% Additional commands when additional computes are requested

% begin_ohpc_run
% ohpc_validation_newline
% ohpc_validation_comment Update basic slurm configuration if additional computes defined
% ohpc_validation_comment This is performed on the SMS, nodes will pick it up config file is copied there later
% ohpc_command if [ ${num_computes} -gt 4 ];then
% ohpc_command    perl -pi -e "s/^NodeName=(\S+)/NodeName=${compute_prefix}[1-${num_computes}]/" /etc/slurm/slurm.conf
% ohpc_command    perl -pi -e "s/^PartitionName=normal Nodes=(\S+)/PartitionName=normal Nodes=${compute_prefix}[1-${num_computes}]/" /etc/slurm/slurm.conf
% ohpc_command fi
% end_ohpc_run

%\clearpage
\subsubsection{Additional Customization ({\em optional})} \label{sec:addl_customizations}
\input{common/compute_customizations_intro}

\paragraph{Increase locked memory limits}
\input{common/memlimits_stateful}

\paragraph{Enable ssh control via resource manager} 
\input{common/slurm_pam_stateful}

\paragraph{Add \Lustre{} client} \label{sec:lustre_client}
\input{common/lustre-client}
\input{common/lustre-client-centos-stateful}
\input{common/lustre-client-post-stateful}

\paragraph{Add \Nagios{} monitoring}
\input{common/nagios_stateful}

\vspace*{0.4cm}
\paragraph{Add \Ganglia{} monitoring}
\input{common/ganglia_stateful}

\paragraph{Add \clustershell{}}
\input{common/clustershell}

\paragraph{Add \mrsh{}}
\input{common/mrsh_stateful}

\paragraph{Add \genders{}}
\input{common/genders}

\clearpage
\paragraph{Add \conman{}} \label{sec:add_conman}
\input{common/conman}

\paragraph{Add \nhc{}} \label{sec:add_nhc}
\input{common/nhc}
\input{common/nhc_slurm}

%\subsubsection{Identify files for synchronization} \label{sec:file_import}
%\input{common/import_xcat_files}
%\input{common/import_xcat_files_slurm}

%%%\subsubsection{Optional kernel arguments} \label{sec:optional_kargs}
%%%\input{common/conman_post}

\section{Install \OHPC{} Development Components}
\input{common/dev_intro.tex}

%\vspace*{-0.15cm}
%\clearpage
\subsection{Development Tools} \label{sec:install_dev_tools}
\input{common/dev_tools}

\vspace*{-0.15cm}
\subsection{Compilers} \label{sec:install_compilers}
\input{common/compilers}

%\clearpage
\subsection{MPI Stacks} \label{sec:mpi}
\input{common/mpi}

\subsection{Performance Tools} \label{sec:install_perf_tools}
\input{common/perf_tools}

\subsection{Setup default development environment}
\input{common/default_dev}

%\vspace*{0.2cm}
\subsection{3rd Party Libraries and Tools} \label{sec:3rdparty}
\input{common/third_party_libs_intro}

\input{common/third_party_libs}
\input{common/third_party_mpi_libs_x86}

\subsection{Optional Development Tool Builds} \label{sec:3rdparty_intel}
\input{common/psxe_enabled_builds}

\vspace*{0.2cm}
\section{Resource Manager Startup} \label{sec:rms_startup}
\input{common/slurm_startup_stateful}

\section{Run a Test Job} \label{sec:test_job}
\input{common/xcat_slurm_test_job}

\clearpage
\appendix
{\bf \LARGE \centerline{Appendices}} \vspace*{0.2cm}

\addcontentsline{toc}{section}{Appendices}
\renewcommand{\thesubsection}{\Alph{subsection}}

\input{common/automation_appendix}
\input{common/upgrade_stateful}
\input{common/test_suite}
\input{common/customization_appendix_centos}
\input{manifest}
\input{common/signature}


\end{document}

