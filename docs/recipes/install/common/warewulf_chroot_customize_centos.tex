Prior to assembling the image, it is advantageous to perform any additional
customization within the chroot environment created for the desired {\em
 compute} instance. The following steps document the process to add a local
{\em ssh} key created by \Warewulf{} to support remote access, 
%identify the resource manager server, configure NTP for compute resources, 
and enable \NFS{}
mounting of a \$HOME file system and the public \OHPC{} install path
(\texttt{/opt/ohpc/pub}) that will be hosted by the {\em master} host in this
example configuration.

\iftoggleverb{isCentOS_ww_pbs_x86}
\vspace*{0.15cm}
%\clearpage
\else
\vspace*{0.15cm}
\fi

% begin_ohpc_run
% ohpc_comment_header Customize system configuration \ref{sec:master_customization}
\begin{lstlisting}[language=bash,literate={-}{-}1,keywords={},upquote=true]
# Initialize warewulf database and ssh_keys
[sms](*\#*) wwinit database
[sms](*\#*) wwinit ssh_keys
\end{lstlisting}
% end_ohpc_run

\paragraph{NFSv3}
To configure NFSv3, you can do the following:

% begin_ohpc_run
\begin{lstlisting}[language=bash,literate={-}{-}1,keywords={},upquote=true]
# Add NFS client mounts of /home and /opt/ohpc/pub to base image
[sms](*\#*) echo "${sms_ip}:/home /home nfs nfsvers=3,nodev,nosuid 0 0" >> $CHROOT/etc/fstab
[sms](*\#*) echo "${sms_ip}:/opt/ohpc/pub /opt/ohpc/pub nfs nfsvers=3,nodev 0 0" >> $CHROOT/etc/fstab

# Export /home and OpenHPC public packages from master server
[sms](*\#*) echo "/home *(rw,no_subtree_check,fsid=10,no_root_squash)" >> /etc/exports
[sms](*\#*) echo "/opt/ohpc/pub *(ro,no_subtree_check,fsid=11)" >> /etc/exports
[sms](*\#*) exportfs -a
[sms](*\#*) systemctl restart nfs-server
[sms](*\#*) systemctl enable nfs-server
\end{lstlisting}
% end_ohpc_run

\paragraph{NFSv4}
If you would like to configure NFSv4 instead of NFSv3 in order to make
it easier to firewall the service, you can do the following:

% begin_ohpc_run
\begin{lstlisting}[language=bash,keywords={}]
# Add NFSv4 client mounts of /home and /opt/ohpc/pub to base image
[sms](*\#*) echo "${sms_ip}/home /home nfs4 _netdev,nodev,nosuid 0 0" >> $CHROOT/etc/fstab
[sms](*\#*) echo "${sms_ip}/opt/ohpc/pub /opt/ohpc/pub nfs4 _netdev,nodev 0 0" >> $CHROOT/etc/fstab

# Add bind mounts for /home and /opt
[sms](*\#*) echo -e "/home\t\t\t/exports/home\t\tnone\tbind\t\t0 0" >> /etc/fstab
[sms](*\#*) echo -e "/opt\t\t\t/exports/opt\t\tnone\tbind\t\t0 0" >> /etc/fstab
[sms](*\#*) mount -a

# Export /home and OpenHPC public packages from master server
[sms](*\#*) echo "/exports *(fsid=0,no_subtree_check,no_root_squash)" >> /etc/exports.d/ohpc.exports
[sms](*\#*) echo "/exports/home *(rw,no_subtree_check,no_root_squash)" >> /etc/exports.d/ohpc.exports
[sms](*\#*) echo "/opt/ohpc/pub *(ro,no_subtree_check)" >> /etc/exports.d/ohpc.exports
[sms](*\#*) exportfs -a
[sms](*\#*) systemctl restart nfs-server
[sms](*\#*) systemctl enable nfs-server
\end{lstlisting}
% end_ohpc_run
